<!DOCTYPE html>
<html>
<head>
    <script type="module" src="https://cdn.jsdelivr.net/gh/vanillawc/wc-codemirror/index.js"></script>
    <script type="module"
            src="https://cdn.jsdelivr.net/gh/vanillawc/wc-codemirror/mode/javascript/javascript.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
        html, body {
            height: 100%;
        }

        body {
            background-color: black;
        }

        .panel {
            background-color: #2B2B2B;
            color: #fff;
            min-height: 100%;
            flex: 1 1 auto;
        }

        .panel + .panel {
            border-left: 1px solid #1f1f1f;
        }

        .panel-focused {
            flex: 1 0 100%;
            max-width: 100%;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #1f1f1f;
            background-color: #1a1a1a;
        }

        #workspace_container {
            height: 100vh;
            min-height: 100vh;
        }

        #workspace_row {
            height: 100%;
            min-height: 100%;
        }

        .panel-body {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        .panel-output {
            background-color: #1f1f1f;
            border-radius: 0.25rem;
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            min-height: 0;
        }

        .panel-output code {
            display: block;
            white-space: pre-wrap;
            color: #ffc107;
        }

        .repl-input-container {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        #prompt_placeholder {
            white-space: pre-wrap;
            line-height: 25px;
        }

        #repl_input {
            flex: 1;
            min-height: 2rem;
        }

        #repl_input .CodeMirror {
            background-color: transparent;
            color: #ffc107;
            height: auto;
            min-height: 1.5em;
            font-size: 0.875rem;
        }

        #repl_input .CodeMirror-cursor {
            border-left: 1px solid #ffc107;
        }

        #repl_input .CodeMirror-lines {
            padding: 0;
        }

        #repl_input .CodeMirror-scroll {
            max-height: 12rem;
        }

        .panel-body > wc-codemirror {
            flex: 1 1 auto;
            min-height: 0;
        }

        #script_editor {
            flex: 1;
        }

        #script_editor .CodeMirror {
            background-color: #2B2B2B;
            color: #fff;
            height: 100%;
            font-size: 0.875rem;
        }

        .panel-hidden {
            display: none !important;
        }

        .panel-controls .btn {
            color: #f8f9fa;
        }

        .panel-controls .btn:hover {
            color: #212529;
            background-color: #ffc107;
            border-color: #ffc107;
        }
    </style>
</head>
<body class="min-vh-100">
<div class="container-fluid h-100 min-vh-100 p-0" id="workspace_container">
    <div class="row no-gutters h-100" id="workspace_row">
        <div class="col-12 col-lg-6 d-flex flex-column panel" id="script_panel">
            <div class="panel-header d-flex align-items-center flex-wrap">
                <h5 class="mb-0 mr-3">Script Workspace</h5>
                <div class="ml-auto d-flex align-items-center flex-wrap">
                    <div class="btn-group btn-group-sm mr-2 panel-controls" role="group"
                         aria-label="Script view controls">
                        <button type="button" class="btn btn-outline-light js-focus-panel" data-panel="script">Focus</button>
                        <button type="button" class="btn btn-outline-light js-show-both">Split View</button>
                    </div>
                    <button id="run_script_button" type="button" class="btn btn-success btn-sm">
                        <span id="run_script_spinner" class="spinner-border spinner-border-sm text-light mr-1 d-none"
                              role="status" aria-hidden="true"></span>
                        <span id="run_script_text">Run</span>
                    </button>
                </div>
            </div>
            <div class="panel-body">
                <wc-codemirror mode="javascript" theme="darcula" id="script_editor" class="w-100 h-100"
                               style="overflow-y:auto; overflow-x:auto;">
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vanillawc/wc-codemirror/theme/darcula.css">
                    <script type="wc-content">
                    // Load data
                    let url = "https://raw.githubusercontent.com/plotly/datasets/master/diabetes.csv";
                    let x = read_matrix(url).transpose();

                    // Massage data
                    let L = x.len;
                    let y = x.drain(|v, i| i == (L-1));
                    let x = ones(1, size(x)[1]) + x;

                    // Do regression and report
                    let b = regress(x.transpose(), y.transpose());
                    b

                    </script>
                </wc-codemirror>
            </div>
        </div>
        <div class="col-12 col-lg-6 d-flex flex-column panel" id="repl_panel">
            <div class="panel-header d-flex align-items-center">
                <h5 class="mb-0">REPL</h5>
                <div class="btn-group btn-group-sm ml-auto panel-controls" role="group" aria-label="REPL view controls">
                    <button type="button" class="btn btn-outline-light js-focus-panel" data-panel="repl">Focus</button>
                    <button type="button" class="btn btn-outline-light js-show-both">Split View</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="panel-output" id="repl_output_holder">
                    <code id="repl_output" class="text-warning"></code>
                </div>
                <div class="repl-input-container">
                    <code id="prompt_placeholder" class="text-warning d-inline">&gt;&gt;&gt; </code>
                    <wc-codemirror id="repl_input" mode="javascript" theme="darcula" class="text-warning w-100"
                                   style="background-color: transparent; overflow-y: auto;">
                        <link rel="stylesheet"
                              href="https://cdn.jsdelivr.net/gh/vanillawc/wc-codemirror/theme/darcula.css">
                    </wc-codemirror>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="module">
    import {configureRhaiCompletions, waitForCodeMirrorEditor} from './rhai-completions.js';

    const tauriApi = window.__TAURI__ || {};
    const invoke = typeof tauriApi.invoke === 'function'
        ? tauriApi.invoke.bind(tauriApi)
        : async () => {
            throw new Error('Tauri API not available');
        };

    document.body.setAttribute('spellcheck', 'false');

    const panels = {
        repl: document.getElementById('repl_panel'),
        script: document.getElementById('script_panel')
    };

    const OutputTarget = Object.freeze({
        repl: 'repl',
        script: 'script'
    });

    const outputTargetStack = [OutputTarget.repl];

    function currentOutputTarget() {
        return outputTargetStack[outputTargetStack.length - 1];
    }

    function pushOutputTarget(target) {
        outputTargetStack.push(target);
    }

    function popOutputTarget(target) {
        if (outputTargetStack.length === 1) {
            return;
        }

        const popped = outputTargetStack.pop();

        if (popped !== target) {
            console.warn('Unexpected output target order', {expected: target, actual: popped});
        }
    }

    function withOutputTarget(target, runner) {
        pushOutputTarget(target);

        try {
            const result = runner();

            if (result && typeof result.finally === 'function') {
                return result.finally(() => {
                    popOutputTarget(target);
                });
            }

            popOutputTarget(target);
            return result;
        } catch (error) {
            popOutputTarget(target);
            throw error;
        }
    }

    function focusPanel(panelId) {
        Object.entries(panels).forEach(([currentId, element]) => {
            if (currentId === panelId) {
                element.classList.remove('panel-hidden');
                element.classList.add('panel-focused');
            } else {
                element.classList.add('panel-hidden');
                element.classList.remove('panel-focused');
            }
        });
    }

    function showBothPanels() {
        Object.values(panels).forEach((element) => {
            element.classList.remove('panel-hidden');
            element.classList.remove('panel-focused');
        });
    }

    function appendReplOutput(payload) {
        let message;

        if (typeof payload === 'string') {
            message = payload;
        } else if (payload === null || payload === undefined) {
            message = '';
        } else {
            try {
                message = JSON.stringify(payload, null, 4);
            } catch (error) {
                console.error('Failed to stringify output payload', error);
                message = String(payload);
            }
        }

        if (message.length > 0 && message.charAt(0) === '#') {
            message = message.substring(1);
        }

        if (message.length > 0) {
            const outputElement = document.getElementById('repl_output');
            outputElement.textContent = `${outputElement.textContent}${message}\n`;
        }

        const holder = document.getElementById('repl_output_holder');
        holder.scroll({top: holder.scrollHeight, behavior: 'smooth'});
    }

    function appendScriptOutput(rawMessage) {
        let message;

        if (typeof rawMessage === 'string') {
            message = rawMessage;
        } else if (rawMessage === null || rawMessage === undefined) {
            message = '';
        } else {
            try {
                message = JSON.stringify(rawMessage);
            } catch (error) {
                console.error('Failed to serialise script output payload', error);
                message = String(rawMessage);
            }
        }

        if (message.charAt(0) === '#') {
            message = message.substring(1);
        }

        try {
            const parsed = JSON.parse(message);
            message = JSON.stringify(parsed, null, 4);
        } catch (error) {
            console.debug('Script output was not JSON serialisable', error);
        }

        const now = new Date().toUTCString();
        const timestamped = `[ ${now} ]\n${message}`;
        appendReplOutput(timestamped);
    }

    function setScriptRunning(isRunning) {
        const spinner = document.getElementById('run_script_spinner');
        const text = document.getElementById('run_script_text');
        const button = document.getElementById('run_script_button');

        if (isRunning) {
            spinner.classList.remove('d-none');
            text.textContent = 'Running';
            button.disabled = true;
        } else {
            spinner.classList.add('d-none');
            text.textContent = 'Run';
            button.disabled = false;
        }
    }

    function initialisePanelControls() {
        document.querySelectorAll('.js-focus-panel').forEach((button) => {
            button.addEventListener('click', () => {
                const panelId = button.getAttribute('data-panel');
                focusPanel(panelId);
            });
        });

        document.querySelectorAll('.js-show-both').forEach((button) => {
            button.addEventListener('click', () => {
                showBothPanels();
            });
        });
    }

    initialisePanelControls();

    window.append_output = (message) => {
        const target = currentOutputTarget();

        if (target === OutputTarget.script) {
            appendScriptOutput(message);
        } else {
            appendReplOutput(message);
        }
    };

    (async () => {
        const replElement = document.getElementById('repl_input');
        const scriptElement = document.getElementById('script_editor');

        const [replEditor, scriptEditor] = await Promise.all([
            waitForCodeMirrorEditor(replElement),
            waitForCodeMirrorEditor(scriptElement)
        ]);

        replEditor.setOption('lineNumbers', false);
        replEditor.setOption('lineWrapping', true);
        replEditor.setOption('viewportMargin', Infinity);

        scriptEditor.setOption('lineNumbers', true);
        scriptEditor.setOption('lineWrapping', true);
        scriptEditor.setOption('viewportMargin', Infinity);

        await Promise.all([
            configureRhaiCompletions(replEditor),
            configureRhaiCompletions(scriptEditor)
        ]);

        const runReplScript = () => {
            const script = replEditor.getValue();
            replEditor.setValue('');
            appendReplOutput(`>>> ${script}`);
            withOutputTarget(OutputTarget.repl, () =>
                invoke('rhai_repl', {script}).catch((error) => {
                    appendReplOutput(`#Failed to run script: ${error}`);
                })
            );
            replEditor.focus();
        };

        const runScript = () => {
            setScriptRunning(true);
            const script = scriptEditor.getValue();
            withOutputTarget(OutputTarget.script, () =>
                invoke('rhai_script', {script})
                    .catch((error) => {
                        appendScriptOutput(`#Failed to run script: ${error}`);
                    })
                    .finally(() => {
                        setScriptRunning(false);
                    })
            );
        };

        const runButton = document.getElementById('run_script_button');
        runButton.addEventListener('click', runScript);

        const existingKeys = replEditor.getOption('extraKeys') || {};
        replEditor.setOption('extraKeys', {
            ...existingKeys,
            Enter: () => {
                runReplScript();
            },
            'Shift-Enter': (cm) => {
                cm.replaceSelection('\n');
            }
        });

        scriptEditor.setOption('extraKeys', {
            ...scriptEditor.getOption('extraKeys'),
            'Ctrl-Enter': runScript,
            'Cmd-Enter': runScript
        });

        replEditor.focus();
        appendScriptOutput('Welcome to pastrami on rhai!');
        setScriptRunning(false);
    })().catch((error) => {
        console.error('Failed to initialise the workspace editors', error);
    });
</script>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
</body>
</html>
